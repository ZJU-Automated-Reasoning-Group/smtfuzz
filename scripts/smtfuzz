#!/usr/bin/env python3
"""
SMTFuzz Unified Command-Line Interface

This script provides a unified interface for all SMTFuzz operations.
"""

import sys
import os
import argparse

# Add the parent directory to the path so we can import smtfuzz
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))


def main():
    parser = argparse.ArgumentParser(
        description="SMTFuzz - SMT Solver Fuzzing Tool",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Available commands:
  seed    Run seed-based fuzzing using existing SMT files
  gen     Run generation-based fuzzing creating new SMT formulas

Examples:
  smtfuzz seed --seed /path/to/seeds --solver z3 --output /tmp/results
  smtfuzz gen --solver cvc5 --logicmode bv --count 100
        """
    )
    
    subparsers = parser.add_subparsers(dest='command', help='Available commands')
    
    # Seed command
    seed_parser = subparsers.add_parser('seed', help='Seed-based fuzzing')
    seed_parser.add_argument('--seed', required=True, help='Path to seed directory')
    seed_parser.add_argument('--solver', default='z3', help='Target solver')
    seed_parser.add_argument('--output', default='~/tmp/res/', help='Output directory')
    seed_parser.add_argument('--timeout', type=int, default=10, help='Timeout for each solving')
    seed_parser.add_argument('--count', type=int, default=50, help='Counts for each combination')
    seed_parser.add_argument('--workers', type=int, default=1, help='Number of threads')
    seed_parser.add_argument('--diff', default='no', help='Enable differential testing')
    seed_parser.add_argument('--perf', default='no', help='Enable performance testing')
    seed_parser.add_argument('--nomut', default='no', help='Disable mutation')
    seed_parser.add_argument('--solvers', default='no', help='Semicolon-separated solver list')
    seed_parser.add_argument('--solvermode', default='default', help='Solver mode')
    seed_parser.add_argument('--logicmode', default='default', help='Logic mode')
    seed_parser.add_argument('--optfuzz', default='no', help='Enable option fuzzing')
    seed_parser.add_argument('-v', '--verbose', action='store_true', help='Verbose output')
    seed_parser.add_argument('-p', '--profile', action='store_true', help='Profile mutation speed')
    
    # Gen command
    gen_parser = subparsers.add_parser('gen', help='Generation-based fuzzing')
    gen_parser.add_argument('--solver', default='z3', help='Target solver')
    gen_parser.add_argument('--output', default='~/tmp/res/', help='Output directory')
    gen_parser.add_argument('--timeout', type=int, default=10, help='Timeout for each solving')
    gen_parser.add_argument('--count', type=int, default=50, help='Counts for each combination')
    gen_parser.add_argument('--workers', type=int, default=1, help='Number of threads')
    gen_parser.add_argument('--solvermode', default='default', help='Solver mode')
    gen_parser.add_argument('--logicmode', default='default', help='Logic mode')
    gen_parser.add_argument('--optfuzz', default='no', help='Enable option fuzzing')
    gen_parser.add_argument('--config', default='no', help='Configuration file')
    gen_parser.add_argument('-v', '--verbose', action='store_true', help='Verbose output')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    if args.command == 'seed':
        from smtfuzz.runner.seed_runner import SeedRunner
        
        # Convert args to the format expected by SeedRunner
        sys.argv = ['smtfuzz-seed']
        for key, value in vars(args).items():
            if key != 'command' and value is not None:
                if isinstance(value, bool) and value:
                    sys.argv.append(f'--{key}')
                elif not isinstance(value, bool):
                    sys.argv.extend([f'--{key}', str(value)])
        
        runner = SeedRunner()
        runner.run()
        
    elif args.command == 'gen':
        from smtfuzz.runner.gen_runner import GenRunner
        
        # Convert args to the format expected by GenRunner
        sys.argv = ['smtfuzz-gen']
        for key, value in vars(args).items():
            if key != 'command' and value is not None:
                if isinstance(value, bool) and value:
                    sys.argv.append(f'--{key}')
                elif not isinstance(value, bool):
                    sys.argv.extend([f'--{key}', str(value)])
        
        runner = GenRunner()
        runner.run()


if __name__ == "__main__":
    main() 